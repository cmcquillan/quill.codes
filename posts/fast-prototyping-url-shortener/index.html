<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
<meta name="description" content="Quickly prototype your first URL Shortener with .NET 5. This tutorial will show you how!" />
<title>Fast Builds: Make a Url Shortener with .NET | Quill.Codes</title>
<link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@500&family=Montserrat&display=swap"
    rel="stylesheet">
<link href="/css/site.css" rel="stylesheet" />
<link href="/css/syntax.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://quill.codes/fast-prototyping-quill-url-shortener.png"/>

<meta name="twitter:title" content="Fast Builds: Make a Url Shortener with .NET"/>
<meta name="twitter:description" content="Quickly prototype your first URL Shortener with .NET 5. This tutorial will show you how!"/>


<meta property="og:title" content="Fast Builds: Make a Url Shortener with .NET" />
<meta property="og:description" content="Quickly prototype your first URL Shortener with .NET 5. This tutorial will show you how!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://quill.codes/posts/fast-prototyping-url-shortener/" />
<meta property="og:image" content="https://quill.codes/fast-prototyping-quill-url-shortener.png" />
<meta property="article:published_time" content="2020-09-22T09:22:48-07:00" />
<meta property="article:modified_time" content="2020-09-22T09:22:48-07:00" />



<script async defer data-domain="quill.codes" src="https://plausible.io/js/plausible.js"></script>

<script>
    function shareFacebook(uri) {
        let newWindow = window.open(
            'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(uri),
            'facebook-share-dialog',
            'width=626,height=436');
    }

    function shareLinkedin(uri) {
        let newWindow = window.open(
            'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(uri),
            'linkedin-share-dialog',
            'width=626,height=640');
    }
</script>
    
    

    
</head>

<body>
    <div class="pageContainer"><header class="header">
    <div class="header--siteTitle">
        <a title="Back to Site Home" class="title header-titleLogo" href="/">
            <object viewBox="0 0 100 100" height="60" data="/images/blog_icon.svg" alt="The Quill.Codes Site Logo. Logo is an inkwell with a Quill superimposed in front."
                type="image/svg+xml">
                The Quill.Codes Site Logo. Logo is an inkwell with a Quill superimposed in front.
            </object>
        </a>
        <a title="Back to Site Home" class="title header--titleLink" href="/">
            Quill.Codes
        </a>
    </div>

    <div class="header--img">
        <img class="header--img-logo" src="/images/profile.png" alt="Picture of Casey (Quill)" />
    </div>

    <div class="header--menu">
        <div class="socialIcons">
            <a title="Casey's Twitter Account" rel="nofollow noopener" target="_blank" href="https://twitter.com/QuillCodes" class="fa fa-twitter socialIcons--icon"></a>
            <a title="Casey's Github Account" rel="nofollow noopener" target="_blank" href="https://github.com/cmcquillan" class="fa fa-github socialIcons--icon"></a>
            <a title="Casey's LinkedIn Account" rel="nofollow noopener" target="_blank" href="https://www.linkedin.com/in/caseymcquillan/"
                class="fa fa-linkedin socialIcons--icon"></a>
            <a title="Quill.Codes RSS Feed" rel="nofollow noopener" target="_blank" href="https://quill.codes/index.xml"
                class="fa fa-rss socialIcons--icon"></a>
        </div>
    </div>

</header><main id="content" class="content">


<div class="blogPostContainer">
  
  <img class="blogPostTitle" src="fast-prototyping-quill-url-shortener.png" alt="A logo with the text &#39;Quill.Codes&#39; and a picture of a large letter &#39;Q&#39; with a quill pen superimposed over it. To the right is text stating &#39;Fast Builds with .NET&#39;" />
  
  <h1 class="postTitle"> Fast Builds: Make a Url Shortener with .NET</h1>
  <aside class="shareIcons">
    <a class="fa fa-facebook" rel="nofollow noopener" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fquill.codes%2fposts%2ffast-prototyping-url-shortener%2f" target="_blank"
      onclick="shareFacebook('https:\/\/quill.codes\/posts\/fast-prototyping-url-shortener\/'); return false;" title="Share on Facebook"></a>
    <a class="fa fa-twitter" rel="nofollow noopener" href="http://twitter.com/share?text=Fast%20Builds%3a%20Make%20a%20Url%20Shortener%20with%20.NET&url=https%3a%2f%2fquill.codes%2fposts%2ffast-prototyping-url-shortener%2f&&via=QuillCodes" target="_blank" title="Share on Twitter"></a>
    <a class="fa fa-linkedin" rel="nofollow noopener" href="https://www.linkedin.com/sharing/share-offsite/?url=https://quill.codes/posts/fast-prototyping-url-shortener/" onclick="shareLinkedin('https:\/\/quill.codes\/posts\/fast-prototyping-url-shortener\/'); return false;" title="Share on LinkedIn"></a>
  </aside>
  <article class="blogPost">
    <div class="blogPost--details">
      <div class="blogPostDetails--postAuthor">
        <span class="blogPostDetails--postAuthor-formattedAuthor">
          Casey McQuillan
        </span>
      </div>
      <div class="blogPostDetails--postDate">
        <span class="blogPostDetails--postDate-formattedDate">September 22, 2020</span>
      </div>
    </div>

    <div class="blogPost--content"><h2 id="fast-prototyping-and-learning-to-code">Fast Prototyping and Learning to Code</h2>
<p>Take a moment to think of your preferred way to learn a new language, framework, or skill. Most likely, there is a certain amount of value that you only get when learning by <em>doing</em>.</p>
<p>I had an interesting transition into development. I already knew a bit about how to code, but I had never had a programming job. At the time, I was working for a company where the dev department was willing to give me a chance, so they sent me <em>an assignment</em>. It was essentially a small file upload application, which I knew I could do.</p>
<p>The problem was that it had to be done in C#, and I had never used C# or .NET before. I had a couple nights to finish, but that had to be juggled around my current job. I tried on my own, failed, looked up docs, tried again, and shortly got to the point where I was writing code and trying to figure out the actual problem. I spent time searching for the right way to structure a class, run a build, and package up a functional project.</p>
<p><strong>I got the job!</strong></p>
<p>Fast forward, months later after I have been onboarded and gotten acquainted with some of the smaller dev tasks, I was sent to &lsquo;training&rsquo;. There were dozens of us in a large classroom watching PowerPoint slides, listening to a lecture on proper syntax, and being given a list of &lsquo;patterns&rsquo; to follow when writing our code.</p>
<p><strong>It could not have been more unhelpful.</strong></p>
<p>Sure, at some point during the class we were told we could write code, but overall we probably spent about three-quarters of our time listening rather than practicing.</p>
<p>I learned <em>incredibly</em> more in a couple frantic nights writing my file uploader than I did in 80 hours of carefully scripted classroom training.</p>
<p><strong>Building a quick, useful app</strong> is an unbelievably useful tool when learning to code. Not only do you get to learn about the concepts employed in the app, you get to see results extremely quickly. There is a fantastic feedback loop that takes place when you get to <em>see</em> results.</p>
<p>In this tutorial we are going to focus on a fast prototype for a relatively simple service: a URL shortener.</p>
<h2 id="getting-your-environment-ready">Getting your Environment Ready</h2>
<p>For this tutorial we have a couple tools that will be necessary.</p>
<ul>
<li><a href="https://dotnet.microsoft.com/download/dotnet-core">.NET SDK</a>
<ul>
<li><em>Note: This tutorial uses some features from .NET 5, which is a Release Candidate as of this writing.</em>
<img src="dotnet_versions.png" alt="List of Supported Versions of .NET. The entry for version 5.0.0-rc.1 has a box highlighting it."></li>
</ul>
</li>
<li><a href="https://code.visualstudio.com/">VS Code</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csharp">C# Extension for VS Code</a></li>
</ul>
<h2 id="building-a-url-shortener">Building a URL Shortener</h2>
<p>The plan today is to build a prototype URL shortener. While doing this we are going to explore and learn about a few concepts of .NET 5:</p>
<ul>
<li>Setting up our project</li>
<li>Getting a basic webserver running requests</li>
<li>Serving some data using endpoint routing</li>
<li>Persisting our data in a simple no-frills database</li>
</ul>
<p><em>Note: At this point I should emphasize that this is tutorial code and probably not ready for your full-scale production app. If you really just need a URL shortener there are many <a href="https://github.com/awesome-selfhosted/awesome-selfhosted#url-shorteners">self-hosted options</a> from which you can choose.</em></p>
<h2 id="setting-up-the-project">Setting up the Project</h2>
<p>Our first step is to get our basic project files in place. Let&rsquo;s make a directory for our project and create a few files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">mkdir</span> <span class="n">url-shortener-tutorial</span>
<span class="nb">cd </span><span class="n">url-shortener-tutorial</span>
</code></pre></td></tr></table>
</div>
</div><p>Within this directory we are going to create two files:</p>
<ul>
<li>UrlShortener.csproj</li>
<li>Program.cs</li>
</ul>
<p>The contents of the <code>csproj</code> file will be very simple:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;Project</span> <span class="na">Sdk=</span><span class="s">&#34;Microsoft.NET.Sdk.Web&#34;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;TargetFramework&gt;</span>net5.0<span class="nt">&lt;/TargetFramework&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>This file tells .NET that we are going to be targeting <strong>.NET 5.0</strong> and that we are going to use the <strong>Microsoft<!-- raw HTML omitted -->.NET.Sdk.Web</strong> SDK. This is basically the flavor of .NET that we plan on using. This might feel a bit opaque at first, but at its core this is really just a console application.</p>
<p>You can prove it to yourself just by adding two lines to <strong>Program.cs</strong>.</p>
<h3 id="programcs">Program.cs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Hello, World!&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>And then running it with the <code>dotnet</code> command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="err">❯</span> <span class="n">dotnet</span> <span class="n">run</span>
<span class="n">Hello</span><span class="p">,</span> <span class="n">World</span><span class="p">!</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="running-a-webserver">Running a Webserver</h2>
<p>Now that we have a basic project set up and we can run code, our next step is to get a quick webserver up and running. This will let us respond to requests and start iterating on our solution.</p>
<h3 id="programcs-1">Program.cs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Builder</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Http</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">Host</span><span class="p">.</span><span class="n">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ConfigureWebHostDefaults</span><span class="p">(</span><span class="n">builder</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">ConfigureServices</span><span class="p">(</span><span class="n">services</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="c1">// Add the necessary components for HTTP routing.
</span><span class="c1"></span>            <span class="n">services</span><span class="p">.</span><span class="n">AddRouting</span><span class="p">();</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">app</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="c1">// Use routing in the pipeline.
</span><span class="c1"></span>            <span class="n">app</span><span class="p">.</span><span class="n">UseRouting</span><span class="p">();</span>

            <span class="c1">// Use the endpoint routing module to map URLs to functions.
</span><span class="c1"></span>            <span class="n">app</span><span class="p">.</span><span class="n">UseEndpoints</span><span class="p">((</span><span class="n">endpoints</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">endpoints</span><span class="p">.</span><span class="n">MapGet</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">=&gt;</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&#34;Hello, World!&#34;</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="k">await</span> <span class="n">host</span><span class="p">.</span><span class="n">RunAsync</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><p>This setup is doing a few things for us:</p>
<ol>
<li>It imports the necessary namespaces (think modules in JavaScript or Python) (see <code>using</code> statments) that we need to start serving HTTP requests.</li>
<li>It adds endpoint routing to our application&rsquo;s services.</li>
<li>It instructs our application to use endpoint routing to serve requests</li>
<li>It sets up a single route at our site&rsquo;s root <code>&quot;/&quot;</code> to return the text &ldquo;Hello, World!&rdquo;.</li>
</ol>
<p>We can now use the <code>dotnet run</code> command and visit our site in a browser to see some successful HTTP requests!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="err">❯</span> <span class="n">dotnet</span> <span class="n">run</span>
<span class="n">info</span><span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Hosting</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
      <span class="n">Now</span> <span class="n">listening</span> <span class="n">on</span><span class="err">:</span> <span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="n">localhost</span><span class="err">:</span><span class="n">5000</span>
<span class="n">info</span><span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Hosting</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
      <span class="n">Now</span> <span class="n">listening</span> <span class="n">on</span><span class="err">:</span> <span class="n">https</span><span class="err">:</span><span class="p">//</span><span class="n">localhost</span><span class="err">:</span><span class="n">5001</span>
<span class="n">info</span><span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Hosting</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
      <span class="n">Application</span> <span class="n">started</span><span class="p">.</span> <span class="n">Press</span> <span class="n">Ctrl</span><span class="p">+</span><span class="n">C</span> <span class="n">to</span> <span class="n">shut</span> <span class="n">down</span><span class="p">.</span>
<span class="n">info</span><span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Hosting</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
      <span class="n">Hosting</span> <span class="n">environment</span><span class="err">:</span> <span class="n">Production</span>
<span class="n">info</span><span class="err">:</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">Hosting</span><span class="p">.</span><span class="n">Lifetime</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
      <span class="n">Content</span> <span class="n">root</span> <span class="n">path</span><span class="err">:</span> <span class="n">C:</span><span class="p">\</span><span class="n">src</span><span class="p">\</span><span class="n">url-shortener-tutorial</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="hello_world_browser.png" alt="An image of the chrome web browser pointed to https://localhost:5001/. The browser window displays &ldquo;Hello, World!&rdquo; in plain text."></p>
<h2 id="serving-a-simple-html-interface">Serving a Simple HTML Interface</h2>
<p>For this project, we only need a few components to properly interact with our URL shortener.</p>
<ul>
<li>A simple HTML interface served at our site root (<code>&quot;/&quot;</code>)</li>
<li>An HTTP POST endpoint that allows us to request a short link (we will use <code>&quot;/shorten&quot;</code>)</li>
<li>A fallback HTTP endpoint that redirects all other requests to (for example <code>&quot;/bL92qf&quot;</code> -&gt; <code>https://www.google.com/&quot;</code>)</li>
</ul>
<p>To serve the HTML page we are going to take our existing &ldquo;Hello, World&rdquo; route and map to to a single file. First, we will add our <code>index.html</code> to the project. This can be in the same directory as <strong>Program.cs</strong>.</p>
<h3 id="indexhtml">index.html</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!doctype html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Simple URL Shortener<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://unpkg.com/mvp.css&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">main</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">header</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Simple URL Shortener<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
                Enter your URL below to retrieve the shortened version.
            <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;urlForm&#34;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&#34;application/x-www-form-urlencoded&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;/shorten&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;url&#34;</span><span class="p">&gt;</span>
                    URL
                <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;url&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;url&#34;</span> <span class="p">/&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span><span class="p">&gt;</span>Shorten<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>You will notice that we are just building a very basic form that will send a POST request to the <code>&quot;/shorten&quot;</code> route with a single field named <code>url</code>. We will have to add a little JavaScript later when we actually want to display our shortened link but for now this will suffice.</p>
<p><em>Note: You may notice a this stylesheet reference <code>&lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/mvp.css&quot;&gt;</code> at the top. This is a package called <a href="https://andybrewer.github.io/mvp/">mvp.css</a> by <a href="https://www.andybrewer.com/">Andy Brewer</a> and we are going to use it to give us some basic styling so we can focus on our code.</em></p>
<p>Then in our application we can instruct our endpoint to serve this file.</p>
<h3 id="programcs-2">Program.cs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">app</span><span class="p">.</span><span class="n">UseEndpoints</span><span class="p">((</span><span class="n">endpoints</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">endpoints</span><span class="p">.</span><span class="n">MapGet</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Serve root index.html
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">SendFileAsync</span><span class="p">(</span><span class="s">&#34;index.html&#34;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>We can now run the app again, go to our browser and see our base interface.</p>
<p><img src="url_shortener_base_interface.png" alt="Our simple URL shortener interface. It has a title stating &ldquo;Simple URL Shortener&rdquo;, text stating &ldquo;Enter your URL below to retrieve the shortened version&rdquo;, and a form that contains a single text field and button that says &ldquo;Shorten&rdquo;"></p>
<h2 id="time-to-shorten-some-links">Time to Shorten Some Links!</h2>
<p>Now that we have a basic interface, we can focus a bit more on our link shortening solution. For this we are going to create a new file in our directory and call is <strong>ShortLink.cs</strong>. Here we will define a new <code>class</code> which will hold some data and functionality for our links.</p>
<h3 id="shortlinkcs">ShortLink.cs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.WebUtilities</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ShortLink</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">GetUrlChunk</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Transform the &#34;Id&#34; property on this object into a short piece of text
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">WebEncoders</span><span class="p">.</span><span class="n">Base64UrlEncode</span><span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">Id</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">GetId</span><span class="p">(</span><span class="kt">string</span> <span class="n">urlChunk</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Reverse our short url text back into an interger Id
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">WebEncoders</span><span class="p">.</span><span class="n">Base64UrlDecode</span><span class="p">(</span><span class="n">urlChunk</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Url</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we will use our <code>ShortLink</code> class to iterate on our endpoints and generate some fake URLs.</p>
<h3 id="programcs---add-this-to-the-using-section">Program.cs - Add this to the <code>using</code> section</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// Other using statements ...
</span><span class="c1"></span><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="programcs---modify-your-useendpoints-call">Program.cs - Modify your <code>UseEndpoints</code> call</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">app</span><span class="p">.</span><span class="n">UseEndpoints</span><span class="p">((</span><span class="n">endpoints</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="c1">// Serve root index.html
</span><span class="c1"></span>    <span class="n">endpoints</span><span class="p">.</span><span class="n">MapGet</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">SendFileAsync</span><span class="p">(</span><span class="s">&#34;index.html&#34;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="n">endpoints</span><span class="p">.</span><span class="n">MapPost</span><span class="p">(</span><span class="s">&#34;/shorten&#34;</span><span class="p">,</span> <span class="n">HandleShortenUrl</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="programcs---add-to-the-end-after-await-hostrunasync">Program.cs - Add to the end after <code>await host.RunAsync()</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// Endpoint Methods
</span><span class="c1"></span>
<span class="k">static</span> <span class="n">Task</span> <span class="n">HandleShortenUrl</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Perform basic form validation
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(!</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">HasFormContentType</span> <span class="p">||</span> <span class="p">!</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Form</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status400BadRequest</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&#34;Cannot process request&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Form</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">formData</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">requestedUrl</span> <span class="p">=</span> <span class="n">formData</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>

    <span class="c1">// Test our URL
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(!</span><span class="n">Uri</span><span class="p">.</span><span class="n">TryCreate</span><span class="p">(</span><span class="n">requestedUrl</span><span class="p">,</span> <span class="n">UriKind</span><span class="p">.</span><span class="n">Absolute</span><span class="p">,</span> <span class="k">out</span> <span class="n">Uri</span> <span class="n">result</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status400BadRequest</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&#34;Could not understand URL.&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">url</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>

    <span class="c1">// Temporary short link 
</span><span class="c1"></span>    <span class="kt">var</span> <span class="n">entry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ShortLink</span>
    <span class="p">{</span>
        <span class="n">Id</span> <span class="p">=</span> <span class="m">123</span><span class="n">_456_789</span><span class="p">,</span>
        <span class="n">Url</span> <span class="p">=</span> <span class="n">url</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">urlChunk</span> <span class="p">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">GetUrlChunk</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">responseUri</span> <span class="p">=</span> <span class="s">$&#34;{context.Request.Scheme}://{context.Request.Host}/{urlChunk}&#34;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">responseUri</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>There is a bit to unpack here, so let&rsquo;s go through it piece-by-piece.</p>
<ul>
<li>We add an endpoint that receives a POST request to the <code>&quot;/shorten&quot;</code> path. This will accept the form input that we send from <code>index.html</code></li>
<li>We map the endpoint to a method called <code>HandleShortenUrl</code>.</li>
<li>In the <code>HandleShortenUrl</code> method:
<ul>
<li>We do some basic validation to ensure that we are getting HTML form data and that the form contains our <code>url</code> data in the request. If we do not get this information, we just write an HTTP error to the browser.</li>
<li>We retrieve the URL value and use the built-in <code>Uri.TryCreate</code> method to validate that it parses into a usable URL. If this fails, we once again send an HTTP error to the browser.</li>
<li>Create an instance of our <code>ShortLink</code> class and use the <code>GetUrlChunk()</code> method to construct our shortened link and write it back to the browser. We are hard-coding an <code>Id</code> for now so that we can test.</li>
</ul>
</li>
</ul>
<p>At this point, we should be able to run another test. Run the project, enter a valid URL into your form and you should see the URL in your response.</p>
<h3 id="test-your-form">Test your form</h3>
<p><img src="url_shortener_test_url.png" alt="The Simple URL Shortener form described earlier in this article with the text &ldquo;https://www.google.com/&rdquo; entered in the URL text box."></p>
<h3 id="your-test-response">Your test response</h3>
<p><img src="url_shortener_test_url_response.png" alt="A chrome browser window shorting the URL of https://localhost:5001/shorten with the text &ldquo;https://localhost:5001/Fc1bBw&rdquo; in the content window."></p>
<p><em>Congrats! You are successfully processing requests and returning data to your user. Next we will persist our generated short links to a database.</em></p>
<h2 id="persisting-your-short-links">Persisting Your Short Links</h2>
<p>Up to this point we have avoided adding dependencies to our project. For this section we have to change that by adding a database. We are going to use <a href="https://www.litedb.org/">LiteDB</a>, a simple, lightweight NoSQL database that will let us easily persist our short links to a file so they can be reitreved later.</p>
<h3 id="adding-litedb-to-your-project">Adding LiteDB to Your Project</h3>
<p>When just using a text editor and not a full IDE, generally the easiest way to add a package is via the command line. Run the following command when in your project directory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">dotnet</span> <span class="n">add</span> <span class="n">package</span> <span class="n">LiteDB</span>
</code></pre></td></tr></table>
</div>
</div><p>Functionally, this just edits your <code>csproj</code> file to add a Package Reference. Another option is to add the line to the project file yourself:</p>
<h3 id="urlshortenercsproj">UrlShortener.csproj</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;Project</span> <span class="na">Sdk=</span><span class="s">&#34;Microsoft.NET.Sdk.Web&#34;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;TargetFramework&gt;</span>net5.0<span class="nt">&lt;/TargetFramework&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
  <span class="c">&lt;!-- Added Package Reference: --&gt;</span>
  <span class="nt">&lt;ItemGroup&gt;</span>
    <span class="nt">&lt;PackageReference</span> <span class="na">Include=</span><span class="s">&#34;LiteDB&#34;</span> <span class="na">Version=</span><span class="s">&#34;5.0.9&#34;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/ItemGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we can utilize LiteDB to persist our short links and serve them to users.</p>
<h3 id="persisting-data-to-litedb">Persisting Data to LiteDB</h3>
<p>We can now modify our <strong>Program.cs</strong> file to utilize LiteDB. To do this, the first thing we have to do is add LiteDB to our available services.</p>
<h3 id="programcs-3">Program.cs</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">LiteDB</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="n">Host</span><span class="p">.</span><span class="n">CreateDefaultBuilder</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ConfigureWebHostDefaults</span><span class="p">(</span><span class="n">builder</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">builder</span><span class="p">.</span><span class="n">ConfigureServices</span><span class="p">(</span><span class="n">services</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="c1">// Add the necessary components for HTTP routing.
</span><span class="c1"></span>            <span class="n">services</span><span class="p">.</span><span class="n">AddRouting</span><span class="p">();</span>

            <span class="c1">// Add LiteDB
</span><span class="c1"></span>            <span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ILiteDatabase</span><span class="p">,</span> <span class="n">LiteDatabase</span><span class="p">&gt;(</span><span class="n">_</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">LiteDatabase</span><span class="p">(</span><span class="s">&#34;short-links.db&#34;</span><span class="p">));</span>
        <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>This enables us to <strong>ask</strong> for the <code>ILiteDatabase</code> object in our request methods. ASP<!-- raw HTML omitted -->.NET will hold onto services for us and delivers them to us later in our program&rsquo;s execution. We can now go into our <code>HandleShortenUrl</code> method and use this service to insert our link.</p>
<h3 id="programcs---your-handleshortenurl-method">Program.cs - Your HandleShortenUrl method</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Task</span> <span class="n">HandleShortenUrl</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Perform basic form validation
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(!</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">HasFormContentType</span> <span class="p">||</span> <span class="p">!</span><span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Form</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status400BadRequest</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&#34;Cannot process request&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Form</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">formData</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">requestedUrl</span> <span class="p">=</span> <span class="n">formData</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>

    <span class="c1">// Test our URL
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(!</span><span class="n">Uri</span><span class="p">.</span><span class="n">TryCreate</span><span class="p">(</span><span class="n">requestedUrl</span><span class="p">,</span> <span class="n">UriKind</span><span class="p">.</span><span class="n">Absolute</span><span class="p">,</span> <span class="k">out</span> <span class="n">Uri</span> <span class="n">result</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status400BadRequest</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&#34;Could not understand URL.&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">url</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
    <span class="c1">// Ask for LiteDB and persist a short link
</span><span class="c1"></span>    <span class="kt">var</span> <span class="n">liteDB</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">RequestServices</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">ILiteDatabase</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">links</span> <span class="p">=</span> <span class="n">liteDB</span><span class="p">.</span><span class="n">GetCollection</span><span class="p">&lt;</span><span class="n">ShortLink</span><span class="p">&gt;(</span><span class="n">BsonAutoId</span><span class="p">.</span><span class="n">Int32</span><span class="p">);</span>

    <span class="c1">// Temporary short link 
</span><span class="c1"></span>    <span class="kt">var</span> <span class="n">entry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ShortLink</span>
    <span class="p">{</span>
        <span class="n">Url</span> <span class="p">=</span> <span class="n">url</span>
    <span class="p">};</span>

    <span class="c1">// Insert our short-link
</span><span class="c1"></span>    <span class="n">links</span><span class="p">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">urlChunk</span> <span class="p">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">GetUrlChunk</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">responseUri</span> <span class="p">=</span> <span class="s">$&#34;{context.Request.Scheme}://{context.Request.Host}/{urlChunk}&#34;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">responseUri</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now that we have registered our <code>ILiteDatabase</code> service, <code>HandleShortenUrl</code> is able to retrieve it using <code>context.RequestServices.GetService&lt;ILiteDatabase&gt;()</code>. From here we use the easy LiteDB API to get a <code>ShortLink</code> collection and <code>Insert()</code> it into our database. Finally, we use the same URL generation from before and send it back down to the browser.</p>
<p><em>Note: You may notice this reference to <code>BsonAutoId.Int32</code>. This simply tells LiteDB that this collection will use regular Integers for the <code>Id</code> field.</em></p>
<p>The last step to make this a &lsquo;complete product&rsquo; (as in, redirect users to our short links) is to add a <strong>Fallback Route</strong> which will catch every other visitor to our app and serve up the expanded link.</p>
<p>We are now going to add another route method to our <strong>Program.cs</strong> file.</p>
<h3 id="programcs---add-to-using-section">Program.cs - Add to <code>using</code> section</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="programcs---add-to-useendpoints-call">Program.cs - Add to UseEndpoints() Call</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">endpoints</span><span class="p">.</span><span class="n">MapFallback</span><span class="p">(</span><span class="n">HandleRedirect</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="programcs---add-after-handleshortenurl">Program.cs - Add After <code>HandleShortenUrl</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Task</span> <span class="n">HandleRedirect</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">RequestServices</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">ILiteDatabase</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">collection</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">GetCollection</span><span class="p">&lt;</span><span class="n">ShortLink</span><span class="p">&gt;();</span>

    <span class="kt">var</span> <span class="n">path</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Path</span><span class="p">.</span><span class="n">ToUriComponent</span><span class="p">().</span><span class="n">Trim</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">ShortLink</span><span class="p">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">entry</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">).</span><span class="n">FirstOrDefault</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Redirect</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">Url</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Redirect</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this block we are taking a few steps:</p>
<ol>
<li>We set a <strong>default</strong> path where we will send people if we do not locate a short link for that path.</li>
<li>We parse our the path using data from <code>context.Request.Path</code>. We convert it to a string with <code>ToUriComponent()</code> and then <code>Trim('/')</code> to remove any extra slashes (the request will always come in with one initial slash).</li>
<li>We parse the URL back into an integer id using our <code>ShortLink.GetId()</code> method.</li>
<li>We find that id in the LiteDB collection.</li>
<li>We redirect to that URL if it exists, or to &lsquo;/&rsquo; if nothing was located.</li>
</ol>
<p>When you run the app and visit a short link, you should redirect to the expanded version of the link.</p>
<h2 id="final-touches-to-improve-the-experience">Final Touches to Improve the Experience</h2>
<p>Right now we are still just showing a plain-text url when someone requests a short link. Just a few small changes can allow us to provide a much cleaner user experience while keeping our small prototype form factor. First, we will modify our <code>&quot;/shorten&quot;</code> handler to redirect our user back to <code>index.html</code> with the shortened link. We will then modify <code>index.html</code> to display the link.</p>
<h3 id="programcs---bottom-of-handleshortenurl-method">Program.cs - Bottom of HandleShortenUrl Method</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp">
<span class="kt">var</span> <span class="n">urlChunk</span> <span class="p">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">GetUrlChunk</span><span class="p">();</span>
<span class="kt">var</span> <span class="n">responseUri</span> <span class="p">=</span> <span class="s">$&#34;{context.Request.Scheme}://{context.Request.Host}/{urlChunk}&#34;</span><span class="p">;</span>
<span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Redirect</span><span class="p">(</span><span class="s">$&#34;/#{responseUri}&#34;</span><span class="p">);</span>
<span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>That&rsquo;s it for <strong>Program.cs</strong>, we just replace the <code>context.Response.WriteAsync()</code> with <code>context.Response.Redirect</code> and we set the redirect URL to our root page with URL hash (#). Now with just a little bit of JavaScript we can add that URL to our page.</p>
<h3 id="indexhtml-at-the-bottom-of-your-ltformgt">Index.html at the bottom of your &lt;form&gt;</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">form</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&#34;application/x-www-form-urlencoded&#34;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;POST&#34;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#34;/shorten&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;url&#34;</span><span class="p">&gt;</span>
        URL
    <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;url&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;url&#34;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span><span class="p">&gt;</span>Shorten<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- A a place to put our resulting short link --&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;urlResult&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="indexhtml-right-before-the-ltbodygt-tag">Index.html right before the &lt;/body&gt; tag</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="c">&lt;!-- Add a script to grab the window&#39;s hash and display result --&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span>
            <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">section</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;urlResult&#39;</span><span class="p">);</span>
            <span class="nx">section</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="sb">`&lt;a id=&#34;link&#34; href=&#34;</span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">&#34;&gt;</span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">&lt;/a&gt;`</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now you can do your final run and test!</p>
<p><img src="url_shortener_final_result.png" alt="The Simple URL Shortener page from before, but the URL bar now has the resulting short link and the short link has been added to the page below the &ldquo;Shorten&rdquo; button."></p>
<h2 id="quick-review-and-whats-next">Quick Review and What&rsquo;s Next</h2>
<p>I hope you enjoyed writing a quick prototype URL Shortener! We explored a few concepts in this post, and hopefully you learned a bit about how to write a minimal prototype with ASP<!-- raw HTML omitted -->.NET and .NET 5.</p>
<p>If you learned from creating this prototype, I would encourage your to experiment on your own and start filling in new features or refactoring it to a more &lsquo;production-ready&rsquo; app. Here are a few suggestions based upon things you might want to learn:</p>
<ul>
<li>Refactor the app to use the ASP<!-- raw HTML omitted -->.NET MVC (Model-View-Controller) pattern so that business logic and dependencies are better managed.</li>
<li>Refactor the app to use a remote database like MongoDB or SQL Server.</li>
<li>Right now putting the same URL twice will result in two separate short links. Maybe enhance the link creation logic to avoid duplicate URLs?</li>
</ul>
<p>If you would be interested in a post that goes through any of these ideas, please <a href="https://twitter.com/QuillCodes/">Let me know</a>!</p>
<p>You can also check out the full code for this solution <a href="https://github.com/cmcquillan/fast-aspnet-samples/tree/main/url-shortener-tutorial">on github</a>.</p>
</div>
  </article>
</div>
<div class="blogCommentContainer">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "quill-codes" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


        </main>  
<aside class="tagGroup">
  <header>
    <h2 class="tagGroup--header">Utilities</h2>
    <ul class="tagGroup--list">
      <li class="tagGroupListItem">
        <a href="/apps/fiddle">Web Tools</a>
      </li>
    </ul>
  </header>

  <header>
    <h2 class="tagGroup--header">Tags</h2>
  </header>
  <ul class="tagGroup--list">
    
      <li class="tagGroupListItem">
        <a href="/tags/csharp">
          csharp(4)
        </a>
      </li>
    
      <li class="tagGroupListItem">
        <a href="/tags/dotnet">
          dotnet(4)
        </a>
      </li>
    
      <li class="tagGroupListItem">
        <a href="/tags/syntax-tips">
          syntax-tips(2)
        </a>
      </li>
    
      <li class="tagGroupListItem">
        <a href="/tags/oop">
          oop(1)
        </a>
      </li>
    
      <li class="tagGroupListItem">
        <a href="/tags/productivity">
          productivity(1)
        </a>
      </li>
    
      <li class="tagGroupListItem">
        <a href="/tags/prototyping">
          prototyping(1)
        </a>
      </li>
    
      <li class="tagGroupListItem">
        <a href="/tags/visual-studio">
          visual-studio(1)
        </a>
      </li>
    
  </ul>
</aside></div></body>

</html>
